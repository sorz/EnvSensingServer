{% extends "front.html" %}
{% import 'bootstrap/wtf.html' as wtf %}
{% block title %}EnvSensing{% endblock %}
{% block head %}
  {{ super() }}
  <style>
    #map { height: 500px; }
  </style>
{% endblock %}

{% block main %}
  <form id="filter">
    <label for="date-from">From</label>
    <input type="date" id="date-from" placeholder="yyyy-mm-dd">
    <label for="date-to">To</label>
    <input type="date" id="date-to" placeholder="yyyy-mm-dd">
    <button id="update" class="btn btn-default">Update</button>
  </form>
  <div id="map"></div>
{% endblock %}

{% block foot %}
{{ super() }}
<script>
  var map;
  var updateTimer;

  var $dateFrom = $('input#date-from');
  var $dateTo = $('input#date-to');

  function initMap() {
    map = new google.maps.Map($('#map')[0], {
      center: {lat: 22.18, lng: 113.55}, zoom: 12
    });

    map.addListener('bounds_changed', function() {
      window.clearTimeout(updateTimer);
      updateTimer = window.setTimeout(function() {
        console.log('Updating points');
        console.log(map.getBounds().toJSON());
        updatePoints();
      }, 3000);
    });
  }

  function updatePoints() {
    var url = 'area/';
    var args = map.getBounds().toJSON();
    args.from = $dateFrom.val();
    args.to = $dateTo.val();

    $.getJSON(url, args, function(resp) {
      console.log(resp.count);
    });
  }

  $('#update').click(function(event) {
    event.preventDefault();
    updatePoints();
  });

</script>
<script async defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC_Ja3Oxmtdg05gKml206MOx8J0fE-8ndQ&callback=initMap&libraries=visualization">
</script>
<script async defer
  scr="{{ url_for('static', filename='components/js-marker-clusterer/src/markerclusterer_compiled.js') }}">
{% endblock %}
